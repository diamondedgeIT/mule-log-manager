<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
	xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
	xsi:schemaLocation="http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd">
	
	<sub-flow name="get-business-groups">
		<flow-ref name="login" doc:name="Anypoint Platform Login" />
        <flow-ref name="set-business-groups" doc:name="Set Business Groups" />
	</sub-flow>
	
	<sub-flow name="process-single-group">
		<set-variable variableName="applicationCount" value="#[0]" doc:name="Set Application Counter" />
		<flow-ref name="set-business-group-id" doc:name="Set Business Group ID" />
        <logger level="INFO" message="#[vars.baseLogger] Processing Business Group: #[vars.businessGroupId]" />
        <flow-ref name="set-environment" doc:name="Set Environment ID" />
        <flow-ref name="get-applications" doc:name="Get Applications" />
        <logger level="INFO" message="#[vars.applicationCount]" />
	</sub-flow>
	
	<sub-flow name="process-all-groups">
		<set-variable variableName="applicationCount" value="#[0]" doc:name="Set Application Counter" />
		<foreach collection="#[vars.businessGroups]">
			<set-variable variableName="businessGroupId" value="#[payload.id]" />
			<logger level="INFO" message="#[vars.baseLogger] Processing Business Group: #[payload.name]" />
			<flow-ref name="set-environment" doc:name="Set Environment ID" />
			<flow-ref name="get-applications" doc:name="Get Applications" />
		</foreach>
		<logger level="INFO" message="#[vars.applicationCount]" />
	</sub-flow>
	
</mule>